<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>User profile</title>
		<script src="https://accounts.google.com/gsi/client" async defer></script>
	</head>
	<body>
		<h1>This is profile</h1>
		<h2 id="fn">yr fn is: </h2>
		<img id="image"/>
		<button onclick="logout()">Logout</button>
		<h1>Create and Share Folder</h1>
		<label for="emailInput">Email:</label>
		<input type="text" id="emailInput">
		<button onclick="createAndShareFolder()">Share</button>
		<script type="text/javascript">
			let params = {}
			let regex = /([^&=]+)=([^&]*)/g, m
			while(m = regex.exec(location.href)){
				params[decodeURIComponent(m[1])]=decodeURIComponent(m[2])
			}
			if(Object.keys(params).length > 0){
				localStorage.setItem('authInfo',JSON.stringify(params))
			}
			window.history.pushState({},document.title,"/profile")
			let info = JSON.parse(localStorage.getItem('authInfo'))
			fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${info["access_token"]}`
			)
			.then((data)=>data.json())
			.then((info)=> {
				document.getElementById("fn").innerHTML+= info.name
				document.getElementById("image").setAttribute('src',info.picture)
			})
			function logout(){
				fetch(`https://oauth2.googleapis.com/revoke?token=${info["access_token"]}`,{
					method:'POST',
					headers:{
						'Content-type':'application/x-www-form-urlencoded'
					}
				})
				.then((data)=>{
					location.href="https://oniechat.netlify.app/"
				})
			}
			function createAndShareFolder() {
			  var email = document.getElementById('emailInput').value;
			  var folderName = email;

			  // Replace with your actual access token
			  var accessToken = info['access_token'];

			  // Validate the email using Google Sign-In API
			  google.accounts.id.initialize({
				client_id: 'YOUR_CLIENT_ID'
			  });

			  google.accounts.id.getInfo({
				login_hint: email,
				callback: function(response) {
				  if (response.status === 'FIRST_LOGIN') {
					console.error('Invalid email address or not associated with a Google account.');
					return;
				  }

				  // Email is valid and associated with a Google account
				  // Proceed with folder creation and sharing

				  // Set up the folder creation request parameters
				  var folderData = {
					name: folderName,
					mimeType: 'application/vnd.google-apps.folder'
				  };

				  var folderRequest = new XMLHttpRequest();
				  folderRequest.open('POST', 'https://www.googleapis.com/drive/v3/files');
				  folderRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
				  folderRequest.setRequestHeader('Content-Type', 'application/json');
				  folderRequest.onload = function() {
					if (folderRequest.status === 200) {
					  var folder = JSON.parse(folderRequest.responseText);
					  console.log('Folder created with ID:', folder.id);

					  // Set up the folder sharing request parameters
					  var shareData = {
						role: 'reader',
						type: 'user',
						emailAddress: email
					  };

					  var shareRequest = new XMLHttpRequest();
					  shareRequest.open('POST', `https://www.googleapis.com/drive/v3/files/${folder.id}/permissions`);
					  shareRequest.setRequestHeader('Authorization', 'Bearer ' + accessToken);
					  shareRequest.setRequestHeader('Content-Type', 'application/json');
					  shareRequest.onload = function() {
						if (shareRequest.status === 200) {
						  console.log('Folder shared with user:', email);
						} else {
						  console.error('Error sharing folder:', shareRequest.status, shareRequest.responseText);
						}
					  };

					  // Send the folder sharing request
					  shareRequest.send(JSON.stringify(shareData));
					} else {
					  console.error('Error creating folder:', folderRequest.status, folderRequest.responseText);
					}
				  };

				  // Send the folder creation request
				  folderRequest.send(JSON.stringify(folderData));
				}
			  });
			}

		</script>
	</body>
</html>
