<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>User profile</title>
		<script src="https://accounts.google.com/gsi/client" async defer></script>
		<script src="https://apis.google.com/js/platform.js" async defer></script>
	</head>
	<body>
		<h1>This is profile</h1>
		<h2 id="fn">yr fn is:</h2>
		<img id="image"/>
		<button onclick="logout()">Logout</button>
		<h4 id="ema"></h4>
		<h1>Create and Share Folder</h1>
		<label for="emailInput">Email:</label>
		<input type="text" id="emailInput">
		<button onclick="createAndShareFolder()">Share</button>
		<script type="text/javascript">
			let params = {}
			let regex = /([^&=]+)=([^&]*)/g, m
			var usrdta
			while(m = regex.exec(location.href)){
				params[decodeURIComponent(m[1])]=decodeURIComponent(m[2])
			}
			if(Object.keys(params).length > 0){
				localStorage.setItem('authInfo',JSON.stringify(params))
			}
			window.history.pushState({},document.title,"/profile")
			let info = JSON.parse(localStorage.getItem('authInfo'))
			fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${info["access_token"]}`)
			.then((data)=>data.json())
			.then((info)=> {
				document.getElementById("fn").innerHTML+= info.name;
				document.getElementById("image").setAttribute('src',info.picture);
				document.getElementById("ema").innerHTML = info.email;
				console.log(info);
				usrdta=info;
				handleClientLoad()
			})
			function logout(){
				fetch(`https://oauth2.googleapis.com/revoke?token=${info["access_token"]}`,{
					method:'POST',
					headers:{
						'Content-type':'application/x-www-form-urlencoded'
					}
				})
				.then((data)=>{
					location.href="https://oniechat.netlify.app/"
				})
			}
			function createAndShareFolder() {
				var email = document.getElementById('emailInput').value;
				var folderName = email;
				var accessToken = info["access_token"];
				var folderData = {
					name: folderName,
					mimeType: 'application/vnd.google-apps.folder'
				};
				var request = new XMLHttpRequest();
				request.open('POST', 'https://www.googleapis.com/drive/v3/files');
				request.setRequestHeader('Authorization', 'Bearer ' + accessToken);
				request.setRequestHeader('Content-Type', 'application/json');
				request.onload = function() {
					if (request.status === 200) {
						var folder = JSON.parse(request.responseText);
						console.log('Folder created with ID:', folder.id);
						shareFolderWithUser(folder.id, email, accessToken);
					} else {
						console.error('Error creating folder:', request.status, request.responseText);
					}
				};
				request.send(JSON.stringify(folderData));
			}
			function shareFolderWithUser(folderId, email, accessToken) {
				var requestData = {
					role: 'reader',
					type: 'user',
					emailAddress: email
				};

				var request = new XMLHttpRequest();
					request.open('POST', `https://www.googleapis.com/drive/v3/files/${folderId}/permissions`);
					request.setRequestHeader('Authorization', 'Bearer ' + accessToken);
					request.setRequestHeader('Content-Type', 'application/json');
					request.onload = function() {
					if (request.status === 200) {
						console.log('Folder shared with user:', email);
					} else {
						console.error('Error sharing folder:', request.status, request.responseText);
					}
				};
				request.send(JSON.stringify(requestData));
			}
			function handleClientLoad() {
				gapi.load('client', initClient);
			}
			function initClient() {
				gapi.client.init({
					apiKey: 'AIzaSyDPMNZmZefjhu4t7TGUa-rkm708e3g6Llk',
					discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
				}).then(function() {
					addEmailToFile();
				});
			}
			function addEmailToFile() {
				var fileId = '1636cU8d4ggO5oc9NT9-8M406k6d0w-tha_xTvMinKBY';
				var email = usrdta.email;
				var content = getEmailContent(fileId);
				if (content) {
					content += '\n' + email;
				} else {
					content = email;
				}
				updateFileContent(fileId, content);
			}
			function getEmailContent(fileId) {
				var request = gapi.client.drive.files.get({
				fileId: fileId,
				alt: 'media'
				});
				return request.then(function(response) {
					return response.body;
				}, function(error) {
					console.error('Error getting file content:', error);
					return null;
				});
			}
			function updateFileContent(fileId, content) {
				var request = gapi.client.request({
					path: '/upload/drive/v3/files/' + fileId,
					method: 'PATCH',
					params: {
						uploadType: 'media'
					},
					headers: {
						'Content-Type': 'text/plain'
					},
					body: content
				});
				request.then(function(response) {
					console.log('File content updated:', response);
					alert('Email added successfully!');
				}, function(error) {
					console.error('Error updating file content:', error);
				});
			}
		</script>
	</body>
</html>
